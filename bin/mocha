#! /bin/bash

echo "[Scraperwiki mocha wrapper]"

THISDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# Prevent recursion
export PATH="$(echo $PATH | sed "s|${THISDIR}||")"

# Clean DB out and load fixtures (set CU_TEST_CLEAN=false to
# avoid cleaning).
if "${CU_TEST_CLEAN-true}"
then
  test/cleaner.coffee
fi

# Consider pushing to external program.
eval last=\${$#}

if [ "$#" = "0" ]
then
    env mocha ${@:1:$#-1} $(find test -name '*.coffee' | sort)
else
    if [ -d "$last" ]
    then
        env mocha ${@:1:$#-1} $(find "$last" -name '*.coffee' | sort)
    else
        env mocha $@
    fi
fi